<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Javascript on Frank Wang&#39;s Coding World</title>
    <link>http://www.wangxingfeng.com/tags/javascript/index.xml</link>
    <description>Recent content in Javascript on Frank Wang&#39;s Coding World</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-CN</language>
    <copyright>[Frank Wang](//www.wangxingfeng.com). Powered by [Hugo](//gohugo.io). Theme by [PPOffice](http://github.com/ppoffice).</copyright>
    <atom:link href="http://www.wangxingfeng.com/tags/javascript/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>两个Safari浏览器不兼容的坑</title>
      <link>http://www.wangxingfeng.com/safari-not-support.html</link>
      <pubDate>Thu, 01 Jun 2017 07:35:15 +0800</pubDate>
      
      <guid>http://www.wangxingfeng.com/safari-not-support.html</guid>
      <description>

&lt;h2 id=&#34;一-苹果手机的safari浏览器不兼容new-date-日期转换格式的坑&#34;&gt;一、 苹果手机的Safari浏览器不兼容new Date()日期转换格式的坑&lt;/h2&gt;

&lt;p&gt;需求：演唱会门票开售时间倒计时。&lt;/p&gt;

&lt;p&gt;思路如下：开售时间减去现在的时间，得出一个时间毫秒数，然后再转换成xx天xx小时xx分xx秒。
so easy! 然后开始写代码。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;
function preSellCount(){
    // 如果没有设置开售时间，则取演出时间，取到的时间格式为2017-06-01 10:00
    var preSt = $(&#39;#preSellTime&#39;).val() || $(&#39;#showTime&#39;).val();  

    // 如果没有设置开售时间，也没有设置演出的时间，则倒计时处显示“开售时间待定”
    if (!preSt) {
        $(&#39;#preSellCount&#39;).text(&amp;quot;开售时间待定&amp;quot;);
    }else{

        //取到的开售时间是一个字符串，先转换成毫秒数，
        var sellTime = new Date(preSt).getTime();

        //现在的毫秒数
        var now = new Date().getTime();

        var count, d, h, min, sec, timeStr, timer;

        count = now &amp;gt; sellTime ? 0 : Math.floor((sellTime-now)/1000);

        // 定时器
        timer = setInterval(function() {
            if (count === 0) {
                clearInterval(timer);
            }else{
                
                // 天数
                d = Math.floor(count/86400); 

                // 小时数
                h = Math.floor(count%86400/3600); 

                // 分钟数
                min = Math.floor(count%86400%3600/60); 

                // 秒钟数
                sec = Math.floor(count%86400%3600%60);

                // 小于10的时候，前面补一个‘0’。
                if (min &amp;lt; 10) {
                    min = &#39;0&#39; + min;
                }
                if (sec &amp;lt; 10 ) {
                    sec = &#39;0&#39; + sec;
                }

                if (d == 0) {
                    timeStr =  h + &amp;quot;小时&amp;quot; + min + &amp;quot;分&amp;quot; + s + &amp;quot;秒&amp;quot;;
                }else{
                    timeStr = d + &amp;quot;天&amp;quot; + h + &amp;quot;小时&amp;quot; + min + &amp;quot;分&amp;quot; + s + &amp;quot;秒&amp;quot;;
                }
                // 得到倒计时的时间字符串
                timeStr = d + &amp;quot;天&amp;quot; + h + &amp;quot;小时&amp;quot; + min + &amp;quot;分&amp;quot; + sec + &amp;quot;秒&amp;quot;;

                // 将字倒计时显示到页面上
                $(&#39;#preSellCount&#39;).text(timeStr);

                count -= 1;
            }
        }, 1000);
    }
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;用Chrome模拟各种手机调试都是一切正常。发布到本地测试环境，然后用自己的安卓手机访问，也一切正常。再用同事的苹果手机测试，倒计时不显示。WTF?&lt;/p&gt;

&lt;p&gt;想想哪里可能会有兼容性问题呢？从头检查一遍代码。获取开售时间没有问题。取到的开售时间是一个字符串的日期，用&lt;code&gt;new Date(preSt).getTime()&lt;/code&gt;转换成毫秒数，有没有问题呢？Google一下&lt;code&gt;new Date() iOS&lt;/code&gt;， 果然发现有不少相关文章提到iOS下日期转换问题。由于Safari在iOS5及以下对&lt;code&gt;YYYY-MM-DD&lt;/code&gt;格式的日期不支持，所以需要转换格式。最简单的是用&lt;code&gt;正则表达式&lt;/code&gt;把日期转换成 &lt;code&gt;YYYY/MM/DD&lt;/code&gt;格式&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;
    preSt.replace(/-/g, &amp;quot;/&amp;quot;)

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;最终的代码是这样的：&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;
function preSellCount(){
    // 如果没有设置开售时间，则取演出时间，取到的时间格式为2017-06-01 10:00
    var preSt = $(&#39;#preSellTime&#39;).val() || $(&#39;#showTime&#39;).val();  

    // 如果没有设置开售时间，也没有设置演出的时间，则倒计时处显示“开售时间待定”
    if (!preSt) {
        $(&#39;#preSellCount&#39;).text(&amp;quot;开售时间待定&amp;quot;);
    }else{

        //取到的开售时间是一个字符串，先转换成毫秒数，
        var sellTime = new Date(preSt.replace(/-/g, &amp;quot;/&amp;quot;)).getTime();

        //现在的毫秒数
        var now = new Date().getTime();

        var count, d, h, min, sec, timeStr, timer;

        count = now &amp;gt; sellTime ? 0 : Math.floor((sellTime-now)/1000);

        // 定时器
        timer = setInterval(function() {
            if (count === 0) {
                clearInterval(timer);
            }else{
                
                // 天数
                d = Math.floor(count/86400); 

                // 小时数
                h = Math.floor(count%86400/3600); 

                // 分钟数
                min = Math.floor(count%86400%3600/60); 

                // 秒钟数
                sec = Math.floor(count%86400%3600%60);

                // 小于10的时候，前面补一个‘0’。
                if (min &amp;lt; 10) {
                    min = &#39;0&#39; + min;
                }
                if (sec &amp;lt; 10 ) {
                    sec = &#39;0&#39; + sec;
                }

                if (d == 0) {
                    timeStr =  h + &amp;quot;小时&amp;quot; + min + &amp;quot;分&amp;quot; + s + &amp;quot;秒&amp;quot;;
                }else{
                    timeStr = d + &amp;quot;天&amp;quot; + h + &amp;quot;小时&amp;quot; + min + &amp;quot;分&amp;quot; + s + &amp;quot;秒&amp;quot;;
                }
                // 得到倒计时的时间字符串
                timeStr = d + &amp;quot;天&amp;quot; + h + &amp;quot;小时&amp;quot; + min + &amp;quot;分&amp;quot; + sec + &amp;quot;秒&amp;quot;;

                // 将字倒计时显示到页面上
                $(&#39;#preSellCount&#39;).text(timeStr);

                count -= 1;
            }
        }, 1000);
    }
}

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;二-苹果手机的safari浏览器不支持-keydown-keypress-keyup-change等事件的坑&#34;&gt;二、苹果手机的Safari浏览器不支持 keydown, keypress, keyup, change等事件的坑。&lt;/h2&gt;

&lt;p&gt;需求:在输入框中输入内容时，输入框后边显示清除按钮，点击可以清除输入框中的所有内容&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;
var keyword = $(&amp;quot;#search-keyword&amp;quot;);
var clear = $(&#39;.clear&#39;);

keyword.on(&#39;keyup&#39;, function(event) {
    if($(this).val().length&amp;gt;0){

        //显示清空输入框的小图标
        clear.show();

    }else{

        // 隐藏清空输入框的小图标
        clear.hide();
    }
});

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;但是在iOS的Safari中, keydown、keypress、 keyup、change等事件都无效，考虑监听input和propertychange事件作为代替。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;
var keyword = $(&amp;quot;#search-keyword&amp;quot;);
var clear = $(&#39;.clear&#39;);

keyword.on(&#39;input propertychange&#39;, function(event) {
    if($(this).val().length&amp;gt;0){
        //显示清空输入框的小图标
        clear.show();
    }else{
        // 隐藏清空输入框的小图标
        clear.hide();
    }
});

&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
  </channel>
</rss>